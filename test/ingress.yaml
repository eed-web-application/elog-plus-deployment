apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: elog-plus-backend-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/auth-url: https://vouch.slac.stanford.edu/validate
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # Use the "map" directive to set a variable based on header presence
      map $http_your_header $auth_required {
        default no;
        present yes;
      }
    nginx.ingress.kubernetes.io/server-snippet: |
        auth_request /auth-check;
        auth_request_set $auth_status $upstream_status;
        if ($auth_required = "no") {
          proxy_pass http://elog-plus-backend-service;
        }
  labels:
    name: elog-plus-backend-ingress
spec:
  rules:
  - host: "accel-webapp-dev.slac.stanford.edu"
    http:
      paths:
      - pathType: Prefix
        path: /api/elog(/|$)(.*)
        backend:
          service:
            name: elog-plus-backend-service
            port: 
              number: 80
        